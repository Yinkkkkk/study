<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>ğŸ¯ å¯ç¼–è¾‘ Â· ä¸Šç˜¾ç§¯åˆ†ç³»ç»Ÿ</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background: #f5f7fa;
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        /* å¤´éƒ¨å·¥å…·æ  */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .edit-btn {
            background: #34495e;
            color: white;
            border: none;
            font-size: 1.3rem;
            padding: 12px 20px;
            border-radius: 40px;
            font-weight: 500;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .edit-btn:active { background: #2c3e50; }
        /* ç§¯åˆ†çœ‹æ¿ */
        .scoreboard {
            background: linear-gradient(145deg, #2c3e50, #1e2b37);
            color: white;
            padding: 24px 20px;
            border-radius: 32px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .scoreboard h2 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 400;
            opacity: 0.9;
        }
        .scoreboard .points {
            font-size: 4rem;
            font-weight: 700;
            line-height: 1.2;
            margin: 8px 0 4px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 28px;
            padding: 20px 18px;
            margin-bottom: 24px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.03);
        }
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 6px solid #ffb347;
            padding-left: 16px;
        }
        /* åˆ—è¡¨é¡¹ */
        .list-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .list-item {
            background: #f8f9fc;
            border-radius: 20px;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecf0;
            transition: all 0.1s ease;
        }
        .list-item:active {
            background: #e9ecf0;
            transform: scale(0.99);
        }
        .item-info {
            display: flex;
            flex-direction: column;
        }
        .item-name {
            font-size: 1.2rem;
            font-weight: 500;
        }
        .item-points {
            font-size: 1rem;
            color: #f39c12;
            font-weight: 600;
            margin-top: 4px;
        }
        .button {
            background: #2c3e50;
            border: none;
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            padding: 12px 22px;
            border-radius: 40px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 100px;
            text-align: center;
        }
        .button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button.primary { background: #e67e22; }
        .button.secondary { background: #3498db; }
        .button:disabled {
            opacity: 0.4;
            transform: none;
            pointer-events: none;
        }
        /* è½¬ç›˜åŒºåŸŸ */
        .wheel-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            margin-top: 10px;
        }
        .wheel-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
        }
        .wheel-result {
            background: #ecf0f1;
            border-radius: 50px;
            padding: 14px 24px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            width: fit-content;
            margin: 0 auto;
            border: 2px dashed #b0bec5;
        }
        .footer-note {
            text-align: center;
            color: #7f8c8d;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        /* ---------- ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ ---------- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-content {
            background: white;
            border-radius: 40px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px 24px;
            box-shadow: 0 25px 50px -8px black;
        }
        .modal-content h3 {
            margin-top: 0;
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .edit-section {
            margin-bottom: 32px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
        .edit-section h4 {
            font-size: 1.4rem;
            margin: 0 0 16px 0;
            color: #34495e;
        }
        .edit-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f3f8;
            border-radius: 60px;
            padding: 8px 16px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .edit-item input {
            flex: 1 1 200px;
            padding: 12px 18px;
            border: none;
            border-radius: 40px;
            font-size: 1rem;
            background: white;
            border: 1px solid #ccd7e4;
        }
        .edit-item input[type="number"] { width: 100px; flex: 0 1 100px; }
        .edit-item button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 10px 18px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 12px 22px;
            font-size: 1rem;
            margin-top: 12px;
            cursor: pointer;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 30px;
        }
        .modal-actions button {
            padding: 16px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 60px;
            background: #b0bec5;
        }
        .modal-actions .save-btn {
            background: #2c3e50;
            color: white;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- é¡¶éƒ¨æ ï¼šç§¯åˆ† + ç¼–è¾‘æŒ‰é’® -->
    <div class="header-bar">
        <div style="font-size:1.4rem; font-weight:600;">ğŸ† å­¦ä¹ é“¶è¡Œ</div>
        <button class="edit-btn" id="openEditorBtn">âœ ç¼–è¾‘</button>
    </div>

    <!-- ç§¯åˆ†çœ‹æ¿ -->
    <div class="scoreboard">
        <h2>ğŸ’° å½“å‰ç§¯åˆ†</h2>
        <div class="points" id="pointsDisplay">0</div>
        <div style="opacity:0.7;">å¤šåŠ³å¤šå¾— Â· è‡ªå®šä¹‰ä¸€åˆ‡</div>
    </div>

    <!-- ä»»åŠ¡å¡ç‰‡ -->
    <div class="card">
        <div class="card-title">ğŸ“‹ é‡å¤ä»»åŠ¡</div>
        <div class="list-grid" id="taskList"></div>
        <hr>
        <div style="color:#5d6d7e; padding:8px 0;">âš¡ ç‚¹å‡»ã€å®Œæˆã€‘è·å¾—ç§¯åˆ†ï¼Œå¯åå¤å®Œæˆã€‚</div>
    </div>

    <!-- å•†åŸå¡ç‰‡ -->
    <div class="card">
        <div class="card-title">ğŸª ç§¯åˆ†å•†åŸ</div>
        <div class="list-grid" id="shopList"></div>
        <hr>
        <div style="color:#5d6d7e;">âœ¨ å…‘æ¢åç§¯åˆ†å‡å°‘ï¼Œæ‰€æœ‰ç‰©å“ä¸é™æ¬¡æ•°ã€‚</div>
    </div>

    <!-- è½¬ç›˜å¡ç‰‡ -->
    <div class="card">
        <div class="card-title">ğŸ² å¹¸è¿å¤§è½¬ç›˜</div>
        <div class="wheel-area">
            <div class="wheel-buttons">
                <button class="button secondary" id="freeSpinBtn">ğŸ†“ å…è´¹è½¬åŠ¨ (æ¯æ—¥ä¸€æ¬¡)</button>
                <button class="button primary" id="paidSpinBtn">ğŸ’° ä»˜è´¹è½¬åŠ¨ (20ç§¯åˆ†)</button>
            </div>
            <div class="wheel-result" id="spinResult">âœ¨ ç‚¹å‡»è½¬ç›˜è¯•è¯•æ‰‹æ°”</div>
            <div style="font-size:0.9rem; background:#fdebd0; padding:10px 18px; border-radius:30px;">
                ğŸ å½“å‰å¥–é¡¹ï¼š<span id="prizeListDisplay"></span>
            </div>
        </div>
    </div>
    <div class="footer-note">â­ æ‰€æœ‰æ•°æ®è‡ªåŠ¨ä¿å­˜ Â· ç‚¹å‡»ç¼–è¾‘æŒ‰é’®è‡ªå®šä¹‰ä»»åŠ¡/å•†åŸ/è½¬ç›˜</div>
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="editorModal">
    <div class="modal-content">
        <h3>âš™ï¸ ç¼–è¾‘é…ç½®</h3>

        <!-- ä»»åŠ¡ç¼–è¾‘åŒº -->
        <div class="edit-section" id="editTasksSection">
            <h4>ğŸ“‹ ä»»åŠ¡åˆ—è¡¨ (åç§°, ç§¯åˆ†)</h4>
            <div id="editTasksContainer"></div>
            <button class="add-btn" id="addTaskBtn">â• æ·»åŠ ä»»åŠ¡</button>
        </div>

        <!-- å•†åŸç¼–è¾‘åŒº -->
        <div class="edit-section" id="editShopSection">
            <h4>ğŸª å•†åŸç‰©å“ (åç§°, ç§¯åˆ†)</h4>
            <div id="editShopContainer"></div>
            <button class="add-btn" id="addShopBtn">â• æ·»åŠ å•†å“</button>
        </div>

        <!-- è½¬ç›˜å¥–é¡¹ç¼–è¾‘åŒº (ç®€å•åˆ—è¡¨ï¼Œå¯é‡å¤) -->
        <div class="edit-section" id="editSpinSection">
            <h4>ğŸ² è½¬ç›˜å¥–é¡¹ (ç§¯åˆ†å€¼ï¼Œå¯é‡å¤ä»¥è°ƒæ¦‚ç‡)</h4>
            <div id="editSpinContainer"></div>
            <button class="add-btn" id="addSpinBtn">â• æ·»åŠ å¥–é¡¹</button>
        </div>

        <div class="modal-actions">
            <button id="cancelEditorBtn">å–æ¶ˆ</button>
            <button class="save-btn" id="saveEditorBtn">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- é»˜è®¤æ•°æ® ----------
        const DEFAULT_TASKS = [
            { name: 'ğŸ“– è‹±è¯­ 25min', points: 10 },
            { name: 'ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™è¯­ 25min', points: 10 },
            { name: 'ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©è¯­ 25min', points: 10 },
            { name: 'ğŸ’» ç¼–ç¨‹ 25min', points: 15 },
            { name: 'ğŸ§  å¿ƒç†å­¦ 25min', points: 10 },
            { name: 'ğŸ¬ çœ‹å¤–è¯­ç”µå½± (åŸå£°)', points: 20 }
        ];
        const DEFAULT_SHOP = [
            { name: 'ğŸ§‹ å¥¶èŒ¶/æœèŒ¶', pointsCost: 30 },
            { name: 'ğŸ® 1å°æ—¶æ¸¸æˆæ—¶é—´', pointsCost: 40 },
            { name: 'ğŸ“– å°è¯´ç« èŠ‚/æœ‰å£°ä¹¦', pointsCost: 15 },
            { name: 'ğŸ¿ ç»¼è‰ºåˆ‡ç‰‡ 20min', pointsCost: 25 },
            { name: 'ğŸ• å¼‚å›½æ–™ç†åŸºé‡‘', pointsCost: 60 },
            { name: 'ğŸ’¤ å…åšå¡ (ä¸€æ¬¡)', pointsCost: 50 }
        ];
        const DEFAULT_SPIN_PRIZES = [5, 10, 20, 50, 0, 10, 5, 15];

        // ä»˜è´¹è½¬ç›˜æ‰€éœ€ç§¯åˆ†
        const SPIN_COST = 20;

        // ---------- å…¨å±€å˜é‡ ----------
        let totalPoints = 100;                 // å½“å‰ç§¯åˆ†
        let lastFreeSpinDate = '';              // ä¸Šæ¬¡å…è´¹è½¬ç›˜æ—¥æœŸ YYYY-MM-DD
        let tasks = [];                         // å½“å‰ä»»åŠ¡
        let shopItems = [];                      // å½“å‰å•†åŸ
        let spinPrizes = [];                      // å½“å‰è½¬ç›˜å¥–é¡¹æ•°ç»„

        // DOM å…ƒç´ 
        const pointsDisplay = document.getElementById('pointsDisplay');
        const taskContainer = document.getElementById('taskList');
        const shopContainer = document.getElementById('shopList');
        const spinResultDiv = document.getElementById('spinResult');
        const freeSpinBtn = document.getElementById('freeSpinBtn');
        const paidSpinBtn = document.getElementById('paidSpinBtn');
        const prizeListSpan = document.getElementById('prizeListDisplay');

        // ç¼–è¾‘å™¨ç›¸å…³
        const modalOverlay = document.getElementById('editorModal');
        const openEditorBtn = document.getElementById('openEditorBtn');
        const cancelEditorBtn = document.getElementById('cancelEditorBtn');
        const saveEditorBtn = document.getElementById('saveEditorBtn');
        const editTasksContainer = document.getElementById('editTasksContainer');
        const editShopContainer = document.getElementById('editShopContainer');
        const editSpinContainer = document.getElementById('editSpinContainer');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const addShopBtn = document.getElementById('addShopBtn');
        const addSpinBtn = document.getElementById('addSpinBtn');

        // ---------- æœ¬åœ°å­˜å‚¨è¯»å†™ ----------
        function loadData() {
            try {
                // ç§¯åˆ†ä¸è½¬ç›˜æ—¥æœŸ
                const savedPoints = localStorage.getItem('totalPoints');
                if (savedPoints !== null) totalPoints = parseInt(savedPoints, 10) || 100;
                const savedDate = localStorage.getItem('lastFreeSpinDate');
                if (savedDate) lastFreeSpinDate = savedDate;

                // ä»»åŠ¡
                const savedTasks = localStorage.getItem('tasks');
                if (savedTasks) tasks = JSON.parse(savedTasks);
                else tasks = DEFAULT_TASKS.map(t => ({...t}));

                // å•†åŸ
                const savedShop = localStorage.getItem('shopItems');
                if (savedShop) shopItems = JSON.parse(savedShop);
                else shopItems = DEFAULT_SHOP.map(s => ({...s}));

                // è½¬ç›˜å¥–é¡¹
                const savedSpin = localStorage.getItem('spinPrizes');
                if (savedSpin) spinPrizes = JSON.parse(savedSpin);
                else spinPrizes = [...DEFAULT_SPIN_PRIZES];
            } catch (e) {
                console.warn('åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', e);
                tasks = DEFAULT_TASKS.map(t => ({...t}));
                shopItems = DEFAULT_SHOP.map(s => ({...s}));
                spinPrizes = [...DEFAULT_SPIN_PRIZES];
            }
        }

        function saveAllToStorage() {
            try {
                localStorage.setItem('totalPoints', totalPoints);
                localStorage.setItem('lastFreeSpinDate', lastFreeSpinDate);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('shopItems', JSON.stringify(shopItems));
                localStorage.setItem('spinPrizes', JSON.stringify(spinPrizes));
            } catch (e) {}
        }

        // ---------- è¾…åŠ©å‡½æ•° ----------
        function getTodayString() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function isFreeSpinAvailable() {
            return lastFreeSpinDate !== getTodayString();
        }

        // ---------- UI æ¸²æŸ“ ----------
        function updatePointsUI() {
            pointsDisplay.innerText = totalPoints;
            saveAllToStorage();
        }

        function renderTasks() {
            taskContainer.innerHTML = '';
            tasks.forEach((task, idx) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${task.name}</span>
                        <span class="item-points">+${task.points} ç§¯åˆ†</span>
                    </div>
                    <button class="button task-btn" data-points="${task.points}" data-index="${idx}">âœ… å®Œæˆ</button>
                `;
                taskContainer.appendChild(item);
            });
            // ç»‘å®šå®Œæˆäº‹ä»¶
            document.querySelectorAll('.task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const points = parseInt(btn.dataset.points, 10);
                    totalPoints += points;
                    updatePointsUI();
                    btn.style.background = '#27ae60';
                    setTimeout(() => btn.style.background = '', 150);
                });
            });
        }

        function renderShop() {
            shopContainer.innerHTML = '';
            shopItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-points">ğŸ”» ${item.pointsCost} ç§¯åˆ†</span>
                    </div>
                    <button class="button primary shop-btn" data-cost="${item.pointsCost}" data-index="${idx}">ğŸ å…‘æ¢</button>
                `;
                shopContainer.appendChild(div);
            });
            document.querySelectorAll('.shop-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cost = parseInt(btn.dataset.cost, 10);
                    if (totalPoints >= cost) {
                        totalPoints -= cost;
                        updatePointsUI();
                        alert(`âœ¨ å…‘æ¢æˆåŠŸï¼`);
                    } else {
                        alert('âŒ ç§¯åˆ†ä¸è¶³');
                    }
                });
            });
        }

        function updateSpinButtons() {
            freeSpinBtn.disabled = !isFreeSpinAvailable();
            freeSpinBtn.innerText = freeSpinBtn.disabled ? 'ğŸ†“ å…è´¹è½¬åŠ¨ (ä»Šæ—¥å·²ç”¨)' : 'ğŸ†“ å…è´¹è½¬åŠ¨ (ä»Šæ—¥å¯ç”¨)';
            if (totalPoints < SPIN_COST) {
                paidSpinBtn.disabled = true;
                paidSpinBtn.innerText = `ğŸ’° ä»˜è´¹è½¬åŠ¨ (éœ€${SPIN_COST}ç§¯åˆ†)`;
            } else {
                paidSpinBtn.disabled = false;
                paidSpinBtn.innerText = `ğŸ’° ä»˜è´¹è½¬åŠ¨ (${SPIN_COST}ç§¯åˆ†)`;
            }
        }

        function updatePrizeListDisplay() {
            if (spinPrizes.length === 0) prizeListSpan.innerText = 'æ— å¥–é¡¹';
            else {
                const unique = [...new Set(spinPrizes)].sort((a,b)=>a-b);
                prizeListSpan.innerText = unique.join(', ') + (unique.includes(0)?' (0=è°¢è°¢)':'');
            }
        }

        // è½¬ç›˜è½¬åŠ¨
        function spinWheel(isFree) {
            if (isFree) {
                if (!isFreeSpinAvailable()) { alert('ä»Šå¤©å…è´¹æ¬¡æ•°å·²ç”¨å®Œ'); return false; }
                lastFreeSpinDate = getTodayString();
            } else {
                if (totalPoints < SPIN_COST) { alert('ç§¯åˆ†ä¸è¶³'); return false; }
                totalPoints -= SPIN_COST;
                updatePointsUI();
            }

            if (spinPrizes.length === 0) {
                alert('è½¬ç›˜å¥–é¡¹ä¸ºç©ºï¼Œè¯·å…ˆç¼–è¾‘æ·»åŠ ');
                return false;
            }

            const randomIndex = Math.floor(Math.random() * spinPrizes.length);
            const prize = spinPrizes[randomIndex];
            totalPoints += prize;
            updatePointsUI();
            spinResultDiv.innerText = prize === 0 ? 'ğŸ‰ è°¢è°¢å‚ä¸ +0' : `ğŸ‰ è·å¾— ${prize} ç§¯åˆ†`;
            spinResultDiv.style.transform = 'scale(1.05)';
            setTimeout(() => spinResultDiv.style.transform = '', 200);
            updateSpinButtons();
            saveAllToStorage();
            return true;
        }

        // åˆ·æ–°æ‰€æœ‰UI
        function refreshAllUI() {
            updatePointsUI();
            renderTasks();
            renderShop();
            updateSpinButtons();
            updatePrizeListDisplay();
        }

        // ---------- ç¼–è¾‘å™¨å¡«å……ä¸æ”¶é›† ----------
        function fillEditor() {
            // ä»»åŠ¡
            editTasksContainer.innerHTML = '';
            tasks.forEach((task, index) => {
                addEditItemRow(editTasksContainer, 'task', index, task.name, task.points);
            });
            // å•†åŸ
            editShopContainer.innerHTML = '';
            shopItems.forEach((item, index) => {
                addEditItemRow(editShopContainer, 'shop', index, item.name, item.pointsCost);
            });
            // è½¬ç›˜å¥–é¡¹
            editSpinContainer.innerHTML = '';
            spinPrizes.forEach((value, index) => {
                addEditSpinRow(editSpinContainer, index, value);
            });
        }

        // æ·»åŠ ä¸€è¡Œä»»åŠ¡/å•†åŸç¼–è¾‘é¡¹ (type: 'task' æˆ– 'shop')
        function addEditItemRow(container, type, index, name, points) {
            const row = document.createElement('div');
            row.className = 'edit-item';
            row.dataset.index = index;
            row.innerHTML = `
                <input type="text" class="edit-name" value="${escapeHtml(name)}" placeholder="åç§°">
                <input type="number" class="edit-points" value="${points}" min="0" step="1" placeholder="ç§¯åˆ†">
                <button class="delete-row" data-type="${type}">ğŸ—‘ åˆ é™¤</button>
            `;
            container.appendChild(row);
        }

        function addEditSpinRow(container, index, value) {
            const row = document.createElement('div');
            row.className = 'edit-item';
            row.dataset.index = index;
            row.innerHTML = `
                <input type="number" class="edit-spin-value" value="${value}" min="0" step="1" placeholder="ç§¯åˆ†å€¼ (0=è°¢è°¢)">
                <button class="delete-spin-row">ğŸ—‘ åˆ é™¤</button>
            `;
            container.appendChild(row);
        }

        // ç®€å•çš„è½¬ä¹‰
        function escapeHtml(unsafe) {
            return unsafe.replace(/[&<>"]/g, function(m) {
                if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
                return m;
            });
        }

        // ä»ç¼–è¾‘å™¨æ”¶é›†æ•°æ®
        function collectEditorData() {
            // ä»»åŠ¡
            const newTasks = [];
            document.querySelectorAll('#editTasksContainer .edit-item').forEach(row => {
                const nameInput = row.querySelector('.edit-name');
                const pointsInput = row.querySelector('.edit-points');
                if (nameInput && pointsInput) {
                    const name = nameInput.value.trim();
                    const points = parseInt(pointsInput.value, 10);
                    if (name !== '' && !isNaN(points) && points >= 0) {
                        newTasks.push({ name, points });
                    }
                }
            });

            // å•†åŸ
            const newShop = [];
            document.querySelectorAll('#editShopContainer .edit-item').forEach(row => {
                const nameInput = row.querySelector('.edit-name');
                const pointsInput = row.querySelector('.edit-points');
                if (nameInput && pointsInput) {
                    const name = nameInput.value.trim();
                    const points = parseInt(pointsInput.value, 10);
                    if (name !== '' && !isNaN(points) && points >= 0) {
                        newShop.push({ name, pointsCost: points });
                    }
                }
            });

            // è½¬ç›˜å¥–é¡¹
            const newSpin = [];
            document.querySelectorAll('#editSpinContainer .edit-item').forEach(row => {
                const valInput = row.querySelector('.edit-spin-value');
                if (valInput) {
                    const val = parseInt(valInput.value, 10);
                    if (!isNaN(val)) newSpin.push(val);
                }
            });

            return { tasks: newTasks, shop: newShop, spin: newSpin };
        }

        // ---------- äº‹ä»¶ç»‘å®š ----------
        function init() {
            loadData();
            refreshAllUI();

            // æ‰“å¼€ç¼–è¾‘å™¨
            openEditorBtn.addEventListener('click', () => {
                fillEditor();
                modalOverlay.style.display = 'flex';
            });

            // å–æ¶ˆ
            cancelEditorBtn.addEventListener('click', () => {
                modalOverlay.style.display = 'none';
            });

            // ä¿å­˜
            saveEditorBtn.addEventListener('click', () => {
                const collected = collectEditorData();
                if (collected.tasks.length > 0) tasks = collected.tasks;
                if (collected.shop.length > 0) shopItems = collected.shop;
                if (collected.spin.length > 0) spinPrizes = collected.spin;
                // å¦‚æœæŸéƒ¨åˆ†ä¸ºç©ºï¼Œä¿ç•™åŸæœ‰ï¼ˆé¿å…è¯¯åˆ ï¼‰
                refreshAllUI();
                saveAllToStorage();
                modalOverlay.style.display = 'none';
            });

            // æ·»åŠ ä»»åŠ¡è¡Œ
            addTaskBtn.addEventListener('click', () => {
                addEditItemRow(editTasksContainer, 'task', Date.now(), '', 0);
            });

            // æ·»åŠ å•†å“è¡Œ
            addShopBtn.addEventListener('click', () => {
                addEditItemRow(editShopContainer, 'shop', Date.now(), '', 0);
            });

            // æ·»åŠ å¥–é¡¹è¡Œ
            addSpinBtn.addEventListener('click', () => {
                addEditSpinRow(editSpinContainer, Date.now(), 0);
            });

            // åˆ é™¤æŒ‰é’®å§”æ‰˜ (ç”±äºåŠ¨æ€æ·»åŠ ï¼Œä½¿ç”¨äº‹ä»¶ç›‘å¬)
            editTasksContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-row')) {
                    e.target.closest('.edit-item').remove();
                }
            });
            editShopContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-row')) {
                    e.target.closest('.edit-item').remove();
                }
            });
            editSpinContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-spin-row')) {
                    e.target.closest('.edit-item').remove();
                }
            });

            // è½¬ç›˜æŒ‰é’®
            freeSpinBtn.addEventListener('click', () => spinWheel(true));
            paidSpinBtn.addEventListener('click', () => spinWheel(false));
        }

        init();
    })();
</script>
</body>
</html>